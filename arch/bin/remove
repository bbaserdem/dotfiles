#!/bin/bash -x
# Wraps aursync command to mount an amazon s3 bucket which contains a repository
set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

# Locations
REPO_NAME=sbp
REMOTE_PATH=s3://sbp-arch/repo
LOCAL_PATH="${HOME}/.cache/${REPO_NAME}-repo"

# Info
mkdir -p "${LOCAL_PATH}"

## Sync remote DB to local ##
s3cmd sync "${REMOTE_PATH}/${REPO_NAME}.db.tar.xz"    "${LOCAL_PATH}/"
ln -sf      "${LOCAL_PATH}/${REPO_NAME}.db.tar.xz"    "${LOCAL_PATH}/$REPO_NAME.db"
s3cmd sync "${REMOTE_PATH}/${REPO_NAME}.files.tar.xz" "${LOCAL_PATH}/"
ln -sf      "${LOCAL_PATH}/${REPO_NAME}.files.tar.xz" "${LOCAL_PATH}/$REPO_NAME.files"

# Remove the packages from this repo
for _arg in "${@}" ; do
    repo-remove "${LOCAL_PATH}/${REPO_NAME}.db.tar.xz" "${_arg}" &&
    s3cmd rm "${REMOTE_PATH}/${_arg}-*.pkg.tar.xz" || true
done

## Sync local database to remote
s3cmd sync --follow-symlinks --acl-public \
    "${LOCAL_PATH}/${REPO_NAME}.db"    "${LOCAL_PATH}/${REPO_NAME}.db.tar.xz" \
    "${LOCAL_PATH}/${REPO_NAME}.files" "${LOCAL_PATH}/${REPO_NAME}.files.tar.xz" \
    "${REMOTE_PATH}/"
